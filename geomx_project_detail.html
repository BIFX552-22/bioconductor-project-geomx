<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.163">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jason Reeves, Prajan Divakar, Nicole Ortogero, Maddy Griswold, Zhi Yang, Stephanie Zimmerman, Rona Vitancol and David Henderson">

<title>Details of Geomx Workflow Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="geomx_project_detail_files/libs/clipboard/clipboard.min.js"></script>
<script src="geomx_project_detail_files/libs/quarto-html/quarto.js"></script>
<script src="geomx_project_detail_files/libs/quarto-html/popper.min.js"></script>
<script src="geomx_project_detail_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="geomx_project_detail_files/libs/quarto-html/anchor.min.js"></script>
<link href="geomx_project_detail_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="geomx_project_detail_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="geomx_project_detail_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="geomx_project_detail_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="geomx_project_detail_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Details of Geomx Workflow Analysis</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jason Reeves, Prajan Divakar, Nicole Ortogero, Maddy Griswold, Zhi Yang, Stephanie Zimmerman, Rona Vitancol and David Henderson </p>
          </div>
  </div>
    
    
  </div>
  

</header>

<p><a href="https://www.bioconductor.org/packages/release/workflows/vignettes/GeoMxWorkflows/inst/doc/GeomxTools_RNA-NGS_Analysis.html">Vignette link</a></p>
<section id="loading-geomx-analysis-packages-and-the-demo-data" class="level2">
<h2 class="anchored" data-anchor-id="loading-geomx-analysis-packages-and-the-demo-data">Loading GeoMx Analysis Packages and the Demo Data</h2>
<div class="cell">

</div>
<div class="cell">

</div>
<div class="cell">

</div>
<p>We will analyze a GeoMx kidney dataset created with the human whole transcriptome atlas (WTA) assay. The dataset includes 4 diabetic kidney disease (DKD) and 3 healthy kidney tissue samples.</p>
<ul>
<li><p>Regions of interest (ROI) were spatially profiled to focus on two different kidney structures: tubules or glomeruli. One glomerular ROI contains the entirety of a single glomerulus. Each tubular ROI contains multiple tubules that were segmented into distal (PanCK+) and proximal (PanCK-) tubule areas of illumination (AOI).</p></li>
<li><p>The key data files are:</p>
<ul>
<li><p>DCCs files - expression count data and sequencing quality metadata</p></li>
<li><p>PKCs file(s) - probe assay metadata describing the gene targets present in the data</p></li>
<li><p>Annotation file - useful tissue information, including the type of segment profiled (ex: glomerulus vs.&nbsp;tubule), segment area/nuclei count, and other tissue characteristics (ex: diseased vs.&nbsp;healthy).</p></li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># locate a specific file path</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># datadir &lt;- file.path("C:/Users/dail/Documents/GeoDX/bioconductor-project-geomx/Kidney_Dataset/")</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>datadir <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"WTA_NGS_Example"</span>,<span class="at">package=</span><span class="st">"GeoMxWorkflows"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># automatically list files in each directory for use</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>DCCFiles <span class="ot">&lt;-</span> <span class="fu">dir</span>(<span class="fu">file.path</span>(datadir, <span class="st">"dccs"</span>), <span class="at">pattern =</span> <span class="st">".dcc$"</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="do">## if load from local file path</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># PKCFiles &lt;- dir(file.path(datadir, "pkcs"), pattern = ".pkc$",</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#                                full.names = TRUE, recursive = TRUE)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>PKCFiles <span class="ot">&lt;-</span> <span class="fu">unzip</span>(<span class="at">zipfile =</span> <span class="fu">dir</span>(<span class="fu">file.path</span>(datadir, <span class="st">"pkcs"</span>), <span class="at">pattern =</span> <span class="st">".zip$"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                                <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>SampleAnnotationFile <span class="ot">&lt;-</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir</span>(<span class="fu">file.path</span>(datadir, <span class="st">"annotation"</span>), <span class="at">pattern =</span> <span class="st">".xlsx$"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>demoData <span class="ot">&lt;-</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">readNanoStringGeoMxSet</span>(<span class="at">dccFiles =</span> DCCFiles,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">pkcFiles =</span> PKCFiles,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">phenoDataFile =</span> SampleAnnotationFile,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">phenoDataSheet =</span> <span class="st">"Template"</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">phenoDataDccColName =</span> <span class="st">"Sample_ID"</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                           <span class="at">protocolDataColNames =</span> <span class="fu">c</span>(<span class="st">"aoi"</span>, <span class="st">"roi"</span>),</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">experimentDataColNames =</span> <span class="fu">c</span>(<span class="st">"panel"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="modules-used" class="level3">
<h3 class="anchored" data-anchor-id="modules-used"><strong>Modules Used</strong></h3>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">PKCs</th>
<th style="text-align: left;">modules</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Hsa_WTA_v1.0.pkc</td>
<td style="text-align: left;">Hsa_WTA_v1.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="geomxset-object-overview" class="level2">
<h2 class="anchored" data-anchor-id="geomxset-object-overview"><strong>GeoMxSet Object Overview</strong></h2>
<p>In the section ‘Loading the Demo Data’, we see that the <code>demoData</code> object is stored as a <code>GeoMxSet Object</code>. <code>GeoMxSet</code> objects are based on <code>ExpressionSet</code> objects, and have many similar functions as those described on Bioconductor. All expression, annotation, and probe information are linked and stored together as shown in the schematic below. There are a few key ways to access the data after we create a GeoMxSet Object. We use these throughout the vignette.</p>
<p><img src="GeoMxSet%20Object%20Overview.png" class="img-fluid"></p>
<p>As is shown above the GeoMxSet object consists of 3 or more elements.</p>
<ul>
<li><p>Expression count matrices - accessed with <code>exprs(object)</code> to return the matrix.</p>
<ul>
<li>As we progress through the analysis we will add new expression matrices to expression slots, or elements (<code>elt</code>), which can be accessed with <code>assayDataElement(object, elt = ...)</code></li>
</ul></li>
<li><p>Segment &amp; Sample annotations - accessed with <code>pData(object)</code></p></li>
<li><p>Probe &amp; Target information - accessed with <code>fData(object)</code></p></li>
<li><p>To learn more about other accessory functions type: <code>?GeomxTools::sData</code></p></li>
</ul>
<p>Both eSets and GeoMxSets use <code>esApply</code> to extend the <a href="https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/apply"><code>apply</code></a> function to such objects. In addition to the <code>esApply</code> function defined by the <code>ExpressionSet</code> class, we have built the <code>assayDataApply</code> function to allow you to select which expression matrix <code>elt</code> you wish to use with the <code>esApply</code> function.</p>
</section>
<section id="qc-pre-processing" class="level2">
<h2 class="anchored" data-anchor-id="qc-pre-processing"><strong>QC &amp; Pre-processing</strong></h2>
<p><img src="QCandPreprocessing.png" class="img-fluid"></p>
<p>The steps above encompass the standard pre-processing workflow for GeoMx data. In short, they represent the selection of ROI/AOI segments and genes based on quality control (QC) or limit of quantification (LOQ) metrics and data normalization.</p>
<p>Before we begin, we will shift any expression counts with a value of 0 to 1 to enable in downstream transformations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Shift counts to one</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>demoData <span class="ot">&lt;-</span> <span class="fu">shiftCountsOne</span>(demoData, <span class="at">useDALogic =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="segment-qc" class="level3">
<h3 class="anchored" data-anchor-id="segment-qc"><strong>Segment QC</strong></h3>
<p>We first assess sequencing quality and adequate tissue sampling for every ROI/AOI segment.</p>
<p>Every ROI/AOI segment will be tested for:</p>
<ul>
<li><p>Raw sequencing reads: segments with &gt;1000 raw reads are removed.</p></li>
<li><p>% Aligned,% Trimmed, or % Stitched sequencing reads: segments below ~80% for one or more of these QC parameters are removed.</p></li>
<li><p>% Sequencing saturation ([1-deduplicated reads/aligned reads]%): segments below ~50% require additional sequencing to capture full sample diversity and are not typically analyzed until improved.</p></li>
<li><p>Negative Count: this is the geometric mean of the several unique negative probes in the GeoMx panel that do not target mRNA and establish the background count level per segment; segments with low negative counts (1-10) are not necessarily removed but may be studied closer for low endogenous gene signal and/or insufficient tissue sampling.</p></li>
<li><p>No Template Control (NTC) count: values &gt;1,000 could indicate contamination for the segments associated with this NTC; however, in cases where the NTC count is between 1,000- 10,000, the segments may be used if the NTC data is uniformly low (e.g.&nbsp;0-2 counts for all probes).</p></li>
<li><p>Nuclei: &gt;100 nuclei per segment is generally recommended; however, this cutoff is highly study/tissue dependent and may need to be reduced; what is most important is consistency in the nuclei distribution for segments within the study.</p></li>
<li><p>Area: generally correlates with nuclei; a strict cutoff is not generally applied based on area.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Default QC cutoffs are commented in () adjacent to the respective parameters</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># study-specific values were selected after visualizing the QC results in more</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># detail below</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>QC_params <span class="ot">&lt;-</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">minSegmentReads =</span> <span class="dv">1000</span>, <span class="co"># Minimum number of reads (1000)</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">percentTrimmed =</span> <span class="dv">80</span>,    <span class="co"># Minimum % of reads trimmed (80%)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">percentStitched =</span> <span class="dv">80</span>,   <span class="co"># Minimum % of reads stitched (80%)</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">percentAligned =</span> <span class="dv">75</span>,    <span class="co"># Minimum % of reads aligned (80%)</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">percentSaturation =</span> <span class="dv">50</span>, <span class="co"># Minimum sequencing saturation (50%)</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">minNegativeCount =</span> <span class="dv">1</span>,   <span class="co"># Minimum negative control counts (10)</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">maxNTCCount =</span> <span class="dv">9000</span>,     <span class="co"># Maximum counts observed in NTC well (1000)</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">minNuclei =</span> <span class="dv">20</span>,         <span class="co"># Minimum # of nuclei estimated (100)</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">minArea =</span> <span class="dv">1000</span>)         <span class="co"># Minimum segment area (5000)</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>demoData <span class="ot">&lt;-</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setSegmentQCFlags</span>(demoData, </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>                      <span class="at">qcCutoffs =</span> QC_params)        </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Collate QC Results</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>QCResults <span class="ot">&lt;-</span> <span class="fu">protocolData</span>(demoData)[[<span class="st">"QCFlags"</span>]]</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>flag_columns <span class="ot">&lt;-</span> <span class="fu">colnames</span>(QCResults)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>QC_Summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Pass =</span> <span class="fu">colSums</span>(<span class="sc">!</span>QCResults[, flag_columns]),</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>                         <span class="at">Warning =</span> <span class="fu">colSums</span>(QCResults[, flag_columns]))</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>QCResults<span class="sc">$</span>QCStatus <span class="ot">&lt;-</span> <span class="fu">apply</span>(QCResults, 1L, <span class="cf">function</span>(x) {</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="fu">sum</span>(x) <span class="sc">==</span> 0L, <span class="st">"PASS"</span>, <span class="st">"WARNING"</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>QC_Summary[<span class="st">"TOTAL FLAGS"</span>, ] <span class="ot">&lt;-</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="fu">sum</span>(QCResults[, <span class="st">"QCStatus"</span>] <span class="sc">==</span> <span class="st">"PASS"</span>),</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sum</span>(QCResults[, <span class="st">"QCStatus"</span>] <span class="sc">==</span> <span class="st">"WARNING"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualize-segment-qc" class="level3">
<h3 class="anchored" data-anchor-id="visualize-segment-qc"><strong>Visualize Segment QC</strong></h3>
<p>Before excluding any low-performing ROI/AOI segments, we visualize the distributions of the data for the different QC parameters. Note that the “Select Segment QC” and “Visualize Segment QC” sections are performed in parallel to fully understand low-performing segments for a given study. Iteration may follow to select the study-specific QC cutoffs.</p>
<p>For QC visualization, we write a quick function to draw histograms of our data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>col_by <span class="ot">&lt;-</span> <span class="st">"segment"</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Graphical summaries of QC statistics plot function</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>QC_histogram <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">assay_data =</span> <span class="cn">NULL</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">annotation =</span> <span class="cn">NULL</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fill_by =</span> <span class="cn">NULL</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">thr =</span> <span class="cn">NULL</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>                         <span class="at">scale_trans =</span> <span class="cn">NULL</span>) {</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    plt <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(assay_data,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">aes_string</span>(<span class="at">x =</span> <span class="fu">paste0</span>(<span class="st">"unlist(`"</span>, annotation, <span class="st">"`)"</span>),</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>                             <span class="at">fill =</span> fill_by)) <span class="sc">+</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> thr, <span class="at">lty =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">facet_wrap</span>(<span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"~"</span>, fill_by)), <span class="at">nrow =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">labs</span>(<span class="at">x =</span> annotation, <span class="at">y =</span> <span class="st">"Segments, #"</span>, <span class="at">title =</span> annotation)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(scale_trans)) {</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        plt <span class="ot">&lt;-</span> plt <span class="sc">+</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>            <span class="fu">scale_x_continuous</span>(<span class="at">trans =</span> scale_trans)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    plt</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we explore each of the QC metrics for the segments.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">QC_histogram</span>(<span class="fu">sData</span>(demoData), <span class="st">"Trimmed (%)"</span>, col_by, <span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `aes_string()` was deprecated in ggplot2 3.0.0.
ℹ Please use tidy evaluation ideoms with `aes()`</code></pre>
</div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">QC_histogram</span>(<span class="fu">sData</span>(demoData), <span class="st">"Stitched (%)"</span>, col_by, <span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">QC_histogram</span>(<span class="fu">sData</span>(demoData), <span class="st">"Aligned (%)"</span>, col_by, <span class="dv">75</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">QC_histogram</span>(<span class="fu">sData</span>(demoData), <span class="st">"Saturated (%)"</span>, col_by, <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Sequencing Saturation (%)"</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Sequencing Saturation (%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">QC_histogram</span>(<span class="fu">sData</span>(demoData), <span class="st">"area"</span>, col_by, <span class="dv">1000</span>, <span class="at">scale_trans =</span> <span class="st">"log10"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">QC_histogram</span>(<span class="fu">sData</span>(demoData), <span class="st">"nuclei"</span>, col_by, <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate the negative geometric means for each module</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>negativeGeoMeans <span class="ot">&lt;-</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">esBy</span>(<span class="fu">negativeControlSubset</span>(demoData), </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">GROUP =</span> <span class="st">"Module"</span>, </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">FUN =</span> <span class="cf">function</span>(x) { </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>             <span class="fu">assayDataApply</span>(x, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> ngeoMean, <span class="at">elt =</span> <span class="st">"exprs"</span>) </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>         }) </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="fu">protocolData</span>(demoData)[[<span class="st">"NegGeoMean"</span>]] <span class="ot">&lt;-</span> negativeGeoMeans</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># explicitly copy the Negative geoMeans from sData to pData</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>negCols <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"NegGeoMean_"</span>, modules)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="fu">pData</span>(demoData)[, negCols] <span class="ot">&lt;-</span> <span class="fu">sData</span>(demoData)[[<span class="st">"NegGeoMean"</span>]]</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(ann <span class="cf">in</span> negCols) {</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    plt <span class="ot">&lt;-</span> <span class="fu">QC_histogram</span>(<span class="fu">pData</span>(demoData), ann, col_by, <span class="dv">2</span>, <span class="at">scale_trans =</span> <span class="st">"log10"</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(plt)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate the negative geometric means for each module</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>negativeGeoMeans <span class="ot">&lt;-</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">esBy</span>(<span class="fu">negativeControlSubset</span>(demoData), </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">GROUP =</span> <span class="st">"Module"</span>, </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">FUN =</span> <span class="cf">function</span>(x) { </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>             <span class="fu">assayDataApply</span>(x, <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> ngeoMean, <span class="at">elt =</span> <span class="st">"exprs"</span>) </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>         }) </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">protocolData</span>(demoData)[[<span class="st">"NegGeoMean"</span>]] <span class="ot">&lt;-</span> negativeGeoMeans</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co"># explicitly copy the Negative geoMeans from sData to pData</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>negCols <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"NegGeoMean_"</span>, modules)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="fu">pData</span>(demoData)[, negCols] <span class="ot">&lt;-</span> <span class="fu">sData</span>(demoData)[[<span class="st">"NegGeoMean"</span>]]</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(ann <span class="cf">in</span> negCols) {</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    plt <span class="ot">&lt;-</span> <span class="fu">QC_histogram</span>(<span class="fu">pData</span>(demoData), ann, col_by, <span class="dv">2</span>, <span class="at">scale_trans =</span> <span class="st">"log10"</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(plt)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Finally we plot all of the QC Summary information in a table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(QC_Summary, <span class="at">caption =</span> <span class="st">"QC Summary Table for each Segment"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>QC Summary Table for each Segment</caption>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">Pass</th>
<th style="text-align: right;">Warning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">LowReads</td>
<td style="text-align: right;">231</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">LowTrimmed</td>
<td style="text-align: right;">235</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LowStitched</td>
<td style="text-align: right;">235</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">LowAligned</td>
<td style="text-align: right;">229</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LowSaturation</td>
<td style="text-align: right;">231</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">LowNegatives</td>
<td style="text-align: right;">235</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HighNTC</td>
<td style="text-align: right;">235</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">LowNuclei</td>
<td style="text-align: right;">235</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LowArea</td>
<td style="text-align: right;">235</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">TOTAL FLAGS</td>
<td style="text-align: right;">229</td>
<td style="text-align: right;">6</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><strong>Remove flagged segments</strong> As the final step in Segment QC, we remove flagged segments that do not meet our QC cutoffs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>demoData <span class="ot">&lt;-</span> demoData[, QCResults<span class="sc">$</span>QCStatus <span class="sc">==</span> <span class="st">"PASS"</span>]</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Subsetting our dataset has removed samples which did not pass QC</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(demoData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Features  Samples 
   18642      229 </code></pre>
</div>
</div>
</section>
<section id="probe-qc" class="level3">
<h3 class="anchored" data-anchor-id="probe-qc"><strong>Probe QC</strong></h3>
<p>Before we summarize our data into gene-level count data, we will remove low-performing probes. In short, this QC is an outlier removal process, whereby probes are either removed entirely from the study (global) or from specific segments (local). The QC applies to gene targets for which there are multiple distinct probes representing the count for a gene per segment. In WTA data, one specific probe exists per target gene; thus, Probe QC does not apply to the endogenous genes in the panel. Rather, it is performed on the negative control probes; there are multiple probes representing our negative controls, which do not target any sequence in the genome. These probes enable calculation of the background per segment and will be important for determining gene detection downstream.</p>
<p>After Probe QC, there will always remain at least one probe representing every gene target. In other words, Probe QC never removes genes from your data.</p>
<section id="set-probe-qc-flags" class="level4">
<h4 class="anchored" data-anchor-id="set-probe-qc-flags"><strong>Set Probe QC Flags</strong></h4>
<p>A probe is removed globally from the dataset if either of the following is true:</p>
<ul>
<li><p>the geometric mean of that probe’s counts from all segments divided by the geometric mean of all probe counts representing the target from all segments is less than 0.1</p></li>
<li><p>the probe is an outlier according to the Grubb’s test in at least 20% of the segments</p></li>
</ul>
<p>A probe is removed locally (from a given segment) if the probe is an outlier according to the Grubb’s test in that segment.</p>
<p>We do not typically adjust these QC parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generally keep the qcCutoffs parameters unchanged. Set removeLocalOutliers to </span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># FALSE if you do not want to remove local outliers</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>demoData <span class="ot">&lt;-</span> <span class="fu">setBioProbeQCFlags</span>(demoData, </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">qcCutoffs =</span> <span class="fu">list</span>(<span class="at">minProbeRatio =</span> <span class="fl">0.1</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">percentFailGrubbs =</span> <span class="dv">20</span>), </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">removeLocalOutliers =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>ProbeQCResults <span class="ot">&lt;-</span> <span class="fu">fData</span>(demoData)[[<span class="st">"QCFlags"</span>]]</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Define QC table for Probe QC</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>qc_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Passed =</span> <span class="fu">sum</span>(<span class="fu">rowSums</span>(ProbeQCResults[, <span class="sc">-</span><span class="dv">1</span>]) <span class="sc">==</span> <span class="dv">0</span>),</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Global =</span> <span class="fu">sum</span>(ProbeQCResults<span class="sc">$</span>GlobalGrubbsOutlier),</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Local =</span> <span class="fu">sum</span>(<span class="fu">rowSums</span>(ProbeQCResults[, <span class="sc">-</span><span class="dv">2</span><span class="sc">:-</span><span class="dv">1</span>]) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>                                <span class="sc">&amp;</span> <span class="sc">!</span>ProbeQCResults<span class="sc">$</span>GlobalGrubbsOutlier))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exclude-outlier-probes" class="level4">
<h4 class="anchored" data-anchor-id="exclude-outlier-probes"><strong>Exclude Outlier Probes</strong></h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Subset object to exclude all that did not pass Ratio &amp; Global testing</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>ProbeQCPassed <span class="ot">&lt;-</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">subset</span>(demoData, </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>           <span class="fu">fData</span>(demoData)[[<span class="st">"QCFlags"</span>]][,<span class="fu">c</span>(<span class="st">"LowProbeRatio"</span>)] <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>               <span class="fu">fData</span>(demoData)[[<span class="st">"QCFlags"</span>]][,<span class="fu">c</span>(<span class="st">"GlobalGrubbsOutlier"</span>)] <span class="sc">==</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(ProbeQCPassed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Features  Samples 
   18641      229 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>demoData <span class="ot">&lt;-</span> ProbeQCPassed </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="create-gene-level-count-data" class="level3">
<h3 class="anchored" data-anchor-id="create-gene-level-count-data"><strong>Create Gene-level Count Data</strong></h3>
<p>With our Probe QC steps complete, we will generate a gene-level count matrix. The count for any gene with multiple probes per segment is calculated as the geometric mean of those probes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check how many unique targets the object has</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">featureData</span>(demoData)[[<span class="st">"TargetName"</span>]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 18504</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># collapse to targets</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>target_demoData <span class="ot">&lt;-</span> <span class="fu">aggregateCounts</span>(demoData)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(target_demoData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Features  Samples 
   18504      229 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exprs</span>(target_demoData)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      DSP-1001250007851-H-A02.dcc DSP-1001250007851-H-A03.dcc
A2M                           485                         262
NAT2                           15                          18
ACADM                          31                          15
ACADS                          27                          17
ACAT1                          29                          24</code></pre>
</div>
</div>
</section>
<section id="section" class="level3">
<h3 class="anchored" data-anchor-id="section"></h3>
<p><strong>Limit of Quantification</strong></p>
<p>In addition to Segment and Probe QC, we also determine the limit of quantification (LOQ) per segment. The LOQ is calculated based on the distribution of negative control probes and is intended to approximate the quantifiable limit of gene expression per segment. Please note that this process is more stable in larger segments. Likewise, the LOQ may not be as accurately reflective of true signal detection rates in segments with low negative probe counts (ex: &lt;2).</p>
<p>We typically use 2 geometric standard deviations (n=2) above the geometric mean as the LOQ, which is reasonable for most studies. We also recommend that a minimum LOQ of 2 be used if the LOQ calculated in a segment is below this threshold.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define LOQ SD threshold and minimum value</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>cutoff <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>minLOQ <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate LOQ per module tested</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>LOQ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">row.names =</span> <span class="fu">colnames</span>(target_demoData))</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(module <span class="cf">in</span> modules) {</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    vars <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">c</span>(<span class="st">"NegGeoMean_"</span>, <span class="st">"NegGeoSD_"</span>),</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>                   module)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">all</span>(vars[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">%in%</span> <span class="fu">colnames</span>(<span class="fu">pData</span>(target_demoData)))) {</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>        LOQ[, module] <span class="ot">&lt;-</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">pmax</span>(minLOQ,</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">pData</span>(target_demoData)[, vars[<span class="dv">1</span>]] <span class="sc">*</span> </span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">pData</span>(target_demoData)[, vars[<span class="dv">2</span>]] <span class="sc">^</span> cutoff)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="fu">pData</span>(target_demoData)<span class="sc">$</span>LOQ <span class="ot">&lt;-</span> LOQ</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="filtering" class="level3">
<h3 class="anchored" data-anchor-id="filtering"><strong>Filtering</strong></h3>
<p>After determining the limit of quantification (LOQ) per segment, we recommend filtering out either segments and/or genes with abnormally low signal. Filtering is an important step to focus on the true biological data of interest.</p>
<p>We determine the number of genes detected in each segment across the dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>LOQ_Mat <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(module <span class="cf">in</span> modules) {</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    ind <span class="ot">&lt;-</span> <span class="fu">fData</span>(target_demoData)<span class="sc">$</span>Module <span class="sc">==</span> module</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    Mat_i <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">esApply</span>(target_demoData[ind, ], <span class="at">MARGIN =</span> <span class="dv">1</span>,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">FUN =</span> <span class="cf">function</span>(x) {</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>                           x <span class="sc">&gt;</span> LOQ[, module]</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>                       }))</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    LOQ_Mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(LOQ_Mat, Mat_i)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ensure ordering since this is stored outside of the geomxSet</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>LOQ_Mat <span class="ot">&lt;-</span> LOQ_Mat[<span class="fu">fData</span>(target_demoData)<span class="sc">$</span>TargetName, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="segment-gene-detection" class="level3">
<h3 class="anchored" data-anchor-id="segment-gene-detection"><strong>Segment Gene Detection</strong></h3>
<p>We first filter out segments with exceptionally low signal. These segments will have a small fraction of panel genes detected above the LOQ relative to the other segments in the study. Let’s visualize the distribution of segments with respect to their % genes detected:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save detection rate information to pheno data</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pData</span>(target_demoData)<span class="sc">$</span>GenesDetected <span class="ot">&lt;-</span> </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colSums</span>(LOQ_Mat, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="fu">pData</span>(target_demoData)<span class="sc">$</span>GeneDetectionRate <span class="ot">&lt;-</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pData</span>(target_demoData)<span class="sc">$</span>GenesDetected <span class="sc">/</span> <span class="fu">nrow</span>(target_demoData)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine detection thresholds: 1%, 5%, 10%, 15%, &gt;15%</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="fu">pData</span>(target_demoData)<span class="sc">$</span>DetectionThreshold <span class="ot">&lt;-</span> </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cut</span>(<span class="fu">pData</span>(target_demoData)<span class="sc">$</span>GeneDetectionRate,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.15</span>, <span class="dv">1</span>),</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"&lt;1%"</span>, <span class="st">"1-5%"</span>, <span class="st">"5-10%"</span>, <span class="st">"10-15%"</span>, <span class="st">"&gt;15%"</span>))</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co"># stacked bar plot of different cut points (1%, 5%, 10%, 15%)</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">pData</span>(target_demoData),</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> DetectionThreshold)) <span class="sc">+</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">fill =</span> region)) <span class="sc">+</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="at">stat =</span> <span class="st">"count"</span>, <span class="fu">aes</span>(<span class="at">label =</span> ..count..), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>))) <span class="sc">+</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Gene Detection Rate"</span>,</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Segments, #"</span>,</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">fill =</span> <span class="st">"Segment Type"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The dot-dot notation (`..count..`) was deprecated in ggplot2 3.4.0.
ℹ Please use `after_stat(count)` instead.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can also create a table to review what kidney tissue type (DKD vs normal) is going to be impacted by each threshold:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># cut percent genes detected at 1, 5, 10, 15</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">table</span>(<span class="fu">pData</span>(target_demoData)<span class="sc">$</span>DetectionThreshold,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>            <span class="fu">pData</span>(target_demoData)<span class="sc">$</span>class))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">DKD</th>
<th style="text-align: right;">normal</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">&lt;1%</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">1-5%</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5-10%</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">10-15%</td>
<td style="text-align: right;">21</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">&gt;15%</td>
<td style="text-align: right;">102</td>
<td style="text-align: right;">94</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>In this example, we choose to remove segments with less than 10% of the genes detected. Generally, 5-10% detection is a reasonable segment filtering threshold. However, based on the experimental design (e.g.&nbsp;segment types, size, nuclei) and tissue characteristics (e.g.&nbsp;type, age), these guidelines may require adjustment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>target_demoData <span class="ot">&lt;-</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    target_demoData[, <span class="fu">pData</span>(target_demoData)<span class="sc">$</span>GeneDetectionRate <span class="sc">&gt;=</span> .<span class="dv">1</span>]</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(target_demoData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Features  Samples 
   18504      221 </code></pre>
</div>
</div>
</section>
<section id="gene-detection-rate" class="level3">
<h3 class="anchored" data-anchor-id="gene-detection-rate"><strong>Gene Detection Rate</strong></h3>
<p>Next, we determine the detection rate for genes across the study. To illustrate this idea, we create a small gene list (<code>goi</code>) to review.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales) <span class="co"># for percent</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate detection rate:</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>LOQ_Mat <span class="ot">&lt;-</span> LOQ_Mat[, <span class="fu">colnames</span>(target_demoData)]</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="fu">fData</span>(target_demoData)<span class="sc">$</span>DetectedSegments <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(LOQ_Mat, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="fu">fData</span>(target_demoData)<span class="sc">$</span>DetectionRate <span class="ot">&lt;-</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fData</span>(target_demoData)<span class="sc">$</span>DetectedSegments <span class="sc">/</span> <span class="fu">nrow</span>(<span class="fu">pData</span>(target_demoData))</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Gene of interest detection table</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>goi <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"PDCD1"</span>, <span class="st">"CD274"</span>, <span class="st">"IFNG"</span>, <span class="st">"CD8A"</span>, <span class="st">"CD68"</span>, <span class="st">"EPCAM"</span>,</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>         <span class="st">"KRT18"</span>, <span class="st">"NPHS1"</span>, <span class="st">"NPHS2"</span>, <span class="st">"CALB1"</span>, <span class="st">"CLDN8"</span>)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>goi_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Gene =</span> goi,</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">Number =</span> <span class="fu">fData</span>(target_demoData)[goi, <span class="st">"DetectedSegments"</span>],</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">DetectionRate =</span> <span class="fu">percent</span>(<span class="fu">fData</span>(target_demoData)[goi, <span class="st">"DetectionRate"</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="gene-filtering" class="level3">
<h3 class="anchored" data-anchor-id="gene-filtering"><strong>Gene Filtering</strong></h3>
<p>We will graph the total number of genes detected in different percentages of segments. Based on the visualization below, we can better understand global gene detection in our study and select how many low detected genes to filter out of the dataset. Gene filtering increases performance of downstream statistical tests and improves interpretation of true biological signal.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot detection rate:</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>plot_detect <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Freq =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">50</span>))</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>plot_detect<span class="sc">$</span>Number <span class="ot">&lt;-</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">function</span>(x) {<span class="fu">sum</span>(<span class="fu">fData</span>(target_demoData)<span class="sc">$</span>DetectionRate <span class="sc">&gt;=</span> x)}))</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>plot_detect<span class="sc">$</span>Rate <span class="ot">&lt;-</span> plot_detect<span class="sc">$</span>Number <span class="sc">/</span> <span class="fu">nrow</span>(<span class="fu">fData</span>(target_demoData))</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(plot_detect) <span class="ot">&lt;-</span> plot_detect<span class="sc">$</span>Freq</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_detect, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.factor</span>(Freq), <span class="at">y =</span> Rate, <span class="at">fill =</span> Rate)) <span class="sc">+</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">formatC</span>(Number, <span class="at">format =</span> <span class="st">"d"</span>, <span class="at">big.mark =</span> <span class="st">","</span>)),</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">vjust =</span> <span class="fl">1.6</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient2</span>(<span class="at">low =</span> <span class="st">"orange2"</span>, <span class="at">mid =</span> <span class="st">"lightblue"</span>,</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>                         <span class="at">high =</span> <span class="st">"dodgerblue3"</span>, <span class="at">midpoint =</span> <span class="fl">0.65</span>,</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>                         <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>                         <span class="at">labels =</span> scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>percent, <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>                       <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))) <span class="sc">+</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"% of Segments"</span>,</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Genes Detected, % of Panel &gt; LOQ"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We typically set a % Segment cutoff ranging from 5-20% based on the biological diversity of our dataset. For this study, we will select 10% as our cutoff. In other words, we will focus on the genes detected in at least 10% of our segments; we filter out the remainder of the targets.</p>
<p>Note: if we know that a key gene is represented in only a small number of segments (&lt;10%) due to biological diversity, we may select a different cutoff or keep the target gene by manually selecting it for inclusion in the data object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset to target genes detected in at least 10% of the samples.</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   Also manually include the negative control probe, for downstream use</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>negativeProbefData <span class="ot">&lt;-</span> <span class="fu">subset</span>(<span class="fu">fData</span>(target_demoData), CodeClass <span class="sc">==</span> <span class="st">"Negative"</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>neg_probes <span class="ot">&lt;-</span> <span class="fu">unique</span>(negativeProbefData<span class="sc">$</span>TargetName)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>target_demoData <span class="ot">&lt;-</span> </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    target_demoData[<span class="fu">fData</span>(target_demoData)<span class="sc">$</span>DetectionRate <span class="sc">&gt;=</span> <span class="fl">0.1</span> <span class="sc">|</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">fData</span>(target_demoData)<span class="sc">$</span>TargetName <span class="sc">%in%</span> neg_probes, ]</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(target_demoData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Features  Samples 
   10131      221 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># retain only detected genes of interest</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>goi <span class="ot">&lt;-</span> goi[goi <span class="sc">%in%</span> <span class="fu">rownames</span>(target_demoData)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="normalization" class="level2">
<h2 class="anchored" data-anchor-id="normalization"><strong>Normalization</strong></h2>
<p>We will now normalize the GeoMx data for downstream visualizations and differential expression. The two common methods for normalization of DSP-NGS RNA data are i) quartile 3 (Q3) or ii) background normalization.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)  <span class="co"># for melt</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)   <span class="co"># for plot_grid</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Graph Q3 value vs negGeoMean of Negatives</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>ann_of_interest <span class="ot">&lt;-</span> <span class="st">"region"</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>Stat_data <span class="ot">&lt;-</span> </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">row.names =</span> <span class="fu">colnames</span>(<span class="fu">exprs</span>(target_demoData)),</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">Segment =</span> <span class="fu">colnames</span>(<span class="fu">exprs</span>(target_demoData)),</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">Annotation =</span> <span class="fu">pData</span>(target_demoData)[, ann_of_interest],</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">Q3 =</span> <span class="fu">unlist</span>(<span class="fu">apply</span>(<span class="fu">exprs</span>(target_demoData), <span class="dv">2</span>,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>                                 quantile, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">NegProbe =</span> <span class="fu">exprs</span>(target_demoData)[neg_probes, ])</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>Stat_data_m <span class="ot">&lt;-</span> <span class="fu">melt</span>(Stat_data, <span class="at">measure.vars =</span> <span class="fu">c</span>(<span class="st">"Q3"</span>, <span class="st">"NegProbe"</span>),</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">variable.name =</span> <span class="st">"Statistic"</span>, <span class="at">value.name =</span> <span class="st">"Value"</span>)</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>plt1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Stat_data_m,</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> Value, <span class="at">fill =</span> Statistic)) <span class="sc">+</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">40</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">trans =</span> <span class="st">"log2"</span>) <span class="sc">+</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>Annotation, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="dv">3</span>, <span class="at">type =</span> <span class="st">"qual"</span>) <span class="sc">+</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Counts"</span>, <span class="at">y =</span> <span class="st">"Segments, #"</span>)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>plt2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Stat_data,</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> NegProbe, <span class="at">y =</span> Q3, <span class="at">color =</span> Annotation)) <span class="sc">+</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"darkgray"</span>) <span class="sc">+</span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">"none"</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">trans =</span> <span class="st">"log2"</span>) <span class="sc">+</span> </span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">trans =</span> <span class="st">"log2"</span>) <span class="sc">+</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">aspect.ratio =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Negative Probe GeoMean, Counts"</span>, <span class="at">y =</span> <span class="st">"Q3 Value, Counts"</span>)</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>plt3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Stat_data,</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> NegProbe, <span class="at">y =</span> Q3 <span class="sc">/</span> NegProbe, <span class="at">color =</span> Annotation)) <span class="sc">+</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">lty =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"darkgray"</span>) <span class="sc">+</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">trans =</span> <span class="st">"log2"</span>) <span class="sc">+</span> </span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">trans =</span> <span class="st">"log2"</span>) <span class="sc">+</span></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">aspect.ratio =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Negative Probe GeoMean, Counts"</span>, <span class="at">y =</span> <span class="st">"Q3/NegProbe Value, Counts"</span>)</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>btm_row <span class="ot">&lt;-</span> <span class="fu">plot_grid</span>(plt2, plt3, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"B"</span>, <span class="st">""</span>),</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>                     <span class="at">rel_widths =</span> <span class="fu">c</span>(<span class="fl">0.43</span>,<span class="fl">0.57</span>))</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_grid</span>(plt1, btm_row, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">""</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As expected, we see separation of the Q3 and negative probe counts at both the distribution (A) and per segment (B) levels.</p>
<p>Next, we normalize our data. We will use Q3 normalized data moving forward. We use the <code>normalize</code> function from <code>NanoStringNCTools</code> to create normalization factors reflecting each data type. Upper quartile (Q3) normalization is performed using <code>norm_method = "quant"</code> setting the <code>desiredQuantile</code> flag to 0.75. Other quantiles could be specified by changing that value. We save the normalized data to a specific slot using <code>toELT = "q_norm"</code>. Similarly background normalization is performed by setting <code>norm_method = "neg"</code> and <code>toElt = "neg_norm"</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Q3 norm (75th percentile) for WTA/CTA  with or without custom spike-ins</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>target_demoData <span class="ot">&lt;-</span> <span class="fu">normalize</span>(target_demoData ,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">norm_method =</span> <span class="st">"quant"</span>, </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">desiredQuantile =</span> .<span class="dv">75</span>,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">toElt =</span> <span class="st">"q_norm"</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Background normalization for WTA/CTA without custom spike-in</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>target_demoData <span class="ot">&lt;-</span> <span class="fu">normalize</span>(target_demoData ,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>                             <span class="at">norm_method =</span> <span class="st">"neg"</span>, </span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>                             <span class="at">fromElt =</span> <span class="st">"exprs"</span>,</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>                             <span class="at">toElt =</span> <span class="st">"neg_norm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To demonstrate the effects of normalization, we graph representative box plots of the data for individual segments before and after normalization.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize the first 10 segments with each normalization method</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(<span class="fu">exprs</span>(target_demoData)[,<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="st">"#9EDAE5"</span>, <span class="at">main =</span> <span class="st">"Raw Counts"</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">log =</span> <span class="st">"y"</span>, <span class="at">names =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">xlab =</span> <span class="st">"Segment"</span>,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylab =</span> <span class="st">"Counts, Raw"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(<span class="fu">assayDataElement</span>(target_demoData[,<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>], <span class="at">elt =</span> <span class="st">"q_norm"</span>),</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="st">"#2CA02C"</span>, <span class="at">main =</span> <span class="st">"Q3 Norm Counts"</span>,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">log =</span> <span class="st">"y"</span>, <span class="at">names =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">xlab =</span> <span class="st">"Segment"</span>,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylab =</span> <span class="st">"Counts, Q3 Normalized"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(<span class="fu">assayDataElement</span>(target_demoData[,<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>], <span class="at">elt =</span> <span class="st">"neg_norm"</span>),</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="st">"#FF7F0E"</span>, <span class="at">main =</span> <span class="st">"Neg Norm Counts"</span>,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">log =</span> <span class="st">"y"</span>, <span class="at">names =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">xlab =</span> <span class="st">"Segment"</span>,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylab =</span> <span class="st">"Counts, Neg. Normalized"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="unsupervised-analysis" class="level2">
<h2 class="anchored" data-anchor-id="unsupervised-analysis"><strong>Unsupervised Analysis</strong></h2>
<section id="umap-t-sne" class="level3">
<h3 class="anchored" data-anchor-id="umap-t-sne"><strong>UMAP &amp; t-SNE</strong></h3>
<p>One common approach to understanding high-plex data is dimension reduction. Two common methods are UMAP and tSNE, which are non-orthogonally constrained projections that cluster samples based on overall gene expression. In this study, we see by either UMAP (from the <code>umap</code> package) or tSNE (from the <code>Rtsne</code> package), clusters of segments related to structure (glomeruli or tubules) and disease status (normal or diabetic kidney disease).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(umap)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'umap' was built under R version 4.2.2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rtsne)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co"># update defaults for umap to contain a stable random_state (seed)</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>custom_umap <span class="ot">&lt;-</span> umap<span class="sc">::</span>umap.defaults</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>custom_umap<span class="sc">$</span>random_state <span class="ot">&lt;-</span> <span class="dv">42</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co"># run UMAP</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>umap_out <span class="ot">&lt;-</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">umap</span>(<span class="fu">t</span>(<span class="fu">log2</span>(<span class="fu">assayDataElement</span>(target_demoData , <span class="at">elt =</span> <span class="st">"q_norm"</span>))),  </span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">config =</span> custom_umap)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="fu">pData</span>(target_demoData)[, <span class="fu">c</span>(<span class="st">"UMAP1"</span>, <span class="st">"UMAP2"</span>)] <span class="ot">&lt;-</span> umap_out<span class="sc">$</span>layout[, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)]</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">pData</span>(target_demoData),</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> UMAP1, <span class="at">y =</span> UMAP2, <span class="at">color =</span> region, <span class="at">shape =</span> class)) <span class="sc">+</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run tSNE</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>) <span class="co"># set the seed for tSNE as well</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>tsne_out <span class="ot">&lt;-</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Rtsne</span>(<span class="fu">t</span>(<span class="fu">log2</span>(<span class="fu">assayDataElement</span>(target_demoData , <span class="at">elt =</span> <span class="st">"q_norm"</span>))),</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">perplexity =</span> <span class="fu">ncol</span>(target_demoData)<span class="sc">*</span>.<span class="dv">15</span>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="fu">pData</span>(target_demoData)[, <span class="fu">c</span>(<span class="st">"tSNE1"</span>, <span class="st">"tSNE2"</span>)] <span class="ot">&lt;-</span> tsne_out<span class="sc">$</span>Y[, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)]</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">pData</span>(target_demoData),</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> tSNE1, <span class="at">y =</span> tSNE2, <span class="at">color =</span> region, <span class="at">shape =</span> class)) <span class="sc">+</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="clustering-high-cv-genes" class="level3">
<h3 class="anchored" data-anchor-id="clustering-high-cv-genes"><strong>Clustering high CV Genes</strong></h3>
<p>Another approach to explore the data is to calculate the coefficient of variation (CV) for each gene. We then identify genes with high CVs that should have large differences across the various profiled segments. This unbiased approach can reveal highly variable genes across the study.</p>
<p>We plot the results using unsupervised hierarchical clustering, displayed as a heatmap.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pheatmap)  <span class="co"># for pheatmap</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'pheatmap' was built under R version 4.2.2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a log2 transform of the data for analysis</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">assayDataElement</span>(<span class="at">object =</span> target_demoData, <span class="at">elt =</span> <span class="st">"log_q"</span>) <span class="ot">&lt;-</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">assayDataApply</span>(target_demoData, <span class="dv">2</span>, <span class="at">FUN =</span> log, <span class="at">base =</span> <span class="dv">2</span>, <span class="at">elt =</span> <span class="st">"q_norm"</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co"># create CV function</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>calc_CV <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {<span class="fu">sd</span>(x) <span class="sc">/</span> <span class="fu">mean</span>(x)}</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>CV_dat <span class="ot">&lt;-</span> <span class="fu">assayDataApply</span>(target_demoData,</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">elt =</span> <span class="st">"log_q"</span>, <span class="at">MARGIN =</span> <span class="dv">1</span>, calc_CV)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co"># show the highest CD genes and their CV values</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="fu">sort</span>(CV_dat, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  CAMK2N1    AKR1C1      AQP2     GDF15       REN 
0.5886006 0.5114973 0.4607206 0.4196469 0.4193216 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify genes in the top 3rd of the CV values</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>GOI <span class="ot">&lt;-</span> <span class="fu">names</span>(CV_dat)[CV_dat <span class="sc">&gt;</span> <span class="fu">quantile</span>(CV_dat, <span class="fl">0.8</span>)]</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(<span class="fu">assayDataElement</span>(target_demoData[GOI, ], <span class="at">elt =</span> <span class="st">"log_q"</span>),</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">scale =</span> <span class="st">"row"</span>, </span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">show_rownames =</span> <span class="cn">FALSE</span>, <span class="at">show_colnames =</span> <span class="cn">FALSE</span>,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">border_color =</span> <span class="cn">NA</span>,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">clustering_method =</span> <span class="st">"average"</span>,</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">clustering_distance_rows =</span> <span class="st">"correlation"</span>,</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">clustering_distance_cols =</span> <span class="st">"correlation"</span>,</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="fl">0.05</span>),</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"purple3"</span>, <span class="st">"black"</span>, <span class="st">"yellow2"</span>))(<span class="dv">120</span>),</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">annotation_col =</span> </span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>             <span class="fu">pData</span>(target_demoData)[, <span class="fu">c</span>(<span class="st">"class"</span>, <span class="st">"segment"</span>, <span class="st">"region"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="differential-expression" class="level2">
<h2 class="anchored" data-anchor-id="differential-expression"><strong>Differential Expression</strong></h2>
<section id="within-slide-analysis-glomeruli-vs-tubules" class="level3">
<h3 class="anchored" data-anchor-id="within-slide-analysis-glomeruli-vs-tubules"><strong>Within Slide Analysis: Glomeruli vs Tubules</strong></h3>
<p>One informative exploration is to study differences between morphological structures. In this example, we can study differential expression between glomeruli and tubules. We will focus on the diseased kidney tissues. Because we are comparing structures that co-exist within the a given tissue we will use the LMM model with a random slope. Morphological structure (<code>Region</code>) is our test variable. We control for tissue subsampling with <code>slide name</code> using a random slope and intercept; the intercept adjusts for the multiple regions placed per unique tissue, since we have one tissue per slide. If multiple tissues are placed per slide, we would change the intercept variable to the unique tissue name (ex: tissue name, Block ID, etc).</p>
<p>In this analysis we save log<sub>2</sub> fold change estimates and P-values across all levels in the factor of interest. We also apply a Benjamini-Hochberg multiple test correction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert test variables to factors</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pData</span>(target_demoData)<span class="sc">$</span>testRegion <span class="ot">&lt;-</span> </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">factor</span>(<span class="fu">pData</span>(target_demoData)<span class="sc">$</span>region, <span class="fu">c</span>(<span class="st">"glomerulus"</span>, <span class="st">"tubule"</span>))</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="fu">pData</span>(target_demoData)[[<span class="st">"slide"</span>]] <span class="ot">&lt;-</span> </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">factor</span>(<span class="fu">pData</span>(target_demoData)[[<span class="st">"slide name"</span>]])</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="fu">assayDataElement</span>(<span class="at">object =</span> target_demoData, <span class="at">elt =</span> <span class="st">"log_q"</span>) <span class="ot">&lt;-</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">assayDataApply</span>(target_demoData, <span class="dv">2</span>, <span class="at">FUN =</span> log, <span class="at">base =</span> <span class="dv">2</span>, <span class="at">elt =</span> <span class="st">"q_norm"</span>)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="co"># run LMM:</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="co"># formula follows conventions defined by the lme4 package</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(status <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"DKD"</span>, <span class="st">"normal"</span>)) {</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    ind <span class="ot">&lt;-</span> <span class="fu">pData</span>(target_demoData)<span class="sc">$</span>class <span class="sc">==</span> status</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    mixedOutmc <span class="ot">&lt;-</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mixedModelDE</span>(target_demoData[, ind],</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">elt =</span> <span class="st">"log_q"</span>,</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">modelFormula =</span> <span class="sc">~</span> testRegion <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> testRegion <span class="sc">|</span> slide),</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>                     <span class="at">groupVar =</span> <span class="st">"testRegion"</span>,</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nCores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>(),</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>                     <span class="at">multiCore =</span> <span class="cn">FALSE</span>)</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># format results as data.frame</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>    r_test <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, mixedOutmc[<span class="st">"lsmeans"</span>, ])</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    tests <span class="ot">&lt;-</span> <span class="fu">rownames</span>(r_test)</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>    r_test <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(r_test)</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>    r_test<span class="sc">$</span>Contrast <span class="ot">&lt;-</span> tests</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># use lapply in case you have multiple levels of your test factor to</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># correctly associate gene name with it's row in the results table</span></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>    r_test<span class="sc">$</span>Gene <span class="ot">&lt;-</span> </span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="fu">colnames</span>(mixedOutmc),</span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>                      rep, <span class="fu">nrow</span>(mixedOutmc[<span class="st">"lsmeans"</span>, ][[<span class="dv">1</span>]])))</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>    r_test<span class="sc">$</span>Subset <span class="ot">&lt;-</span> status</span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>    r_test<span class="sc">$</span>FDR <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(r_test<span class="sc">$</span><span class="st">`</span><span class="at">Pr(&gt;|t|)</span><span class="st">`</span>, <span class="at">method =</span> <span class="st">"fdr"</span>)</span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>    r_test <span class="ot">&lt;-</span> r_test[, <span class="fu">c</span>(<span class="st">"Gene"</span>, <span class="st">"Subset"</span>, <span class="st">"Contrast"</span>, <span class="st">"Estimate"</span>, </span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"Pr(&gt;|t|)"</span>, <span class="st">"FDR"</span>)]</span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, r_test)</span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="interpreting-the-results-table" class="level3">
<h3 class="anchored" data-anchor-id="interpreting-the-results-table"><strong>Interpreting the results table</strong></h3>
<p>Let’s review the results from the analysis of glomeruli to tubules in healthy (normal) patients. We saved the LMM outputs into a table (<code>results</code>) containing three of the key features for differential expression: the log<sub>2</sub> fold change value (<code>Estimate</code>), P-value (<code>Pr(&gt;|t|)</code>), and false-discovery adjusted P-values (<code>FDR</code>). Let’s take a look at a few genes of interest. The contrast column is used to interpret the log<sub>2</sub> fold change value as it specifies which levels are compared (e.g.&nbsp;positive fold change values when comparing <code>glomerulus - tubule</code> indicates an enrichment in the glomerulus; negative indicates enrichment in tubules).</p>
<p>We can display these results by subsetting the results table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">subset</span>(results, Gene <span class="sc">%in%</span> goi <span class="sc">&amp;</span> Subset <span class="sc">==</span> <span class="st">"normal"</span>), <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"DE results for Genes of Interest"</span>,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">align =</span> <span class="st">"lc"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>DE results for Genes of Interest</caption>
<colgroup>
<col style="width: 8%">
<col style="width: 11%">
<col style="width: 28%">
<col style="width: 14%">
<col style="width: 27%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Gene</th>
<th style="text-align: center;">Subset</th>
<th style="text-align: left;">Contrast</th>
<th style="text-align: center;">Estimate</th>
<th style="text-align: left;">Pr(&gt;|t|)</th>
<th style="text-align: center;">FDR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">KRT18</td>
<td style="text-align: center;">normal</td>
<td style="text-align: left;">glomerulus - tubule</td>
<td style="text-align: center;">-1.169</td>
<td style="text-align: left;">0.076</td>
<td style="text-align: center;">0.237</td>
</tr>
<tr class="even">
<td style="text-align: left;">CD68</td>
<td style="text-align: center;">normal</td>
<td style="text-align: left;">glomerulus - tubule</td>
<td style="text-align: center;">-0.153</td>
<td style="text-align: left;">0.289</td>
<td style="text-align: center;">0.483</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CD8A</td>
<td style="text-align: center;">normal</td>
<td style="text-align: left;">glomerulus - tubule</td>
<td style="text-align: center;">-0.227</td>
<td style="text-align: left;">0.147</td>
<td style="text-align: center;">0.332</td>
</tr>
<tr class="even">
<td style="text-align: left;">NPHS1</td>
<td style="text-align: center;">normal</td>
<td style="text-align: left;">glomerulus - tubule</td>
<td style="text-align: center;">3.809</td>
<td style="text-align: left;">0.001</td>
<td style="text-align: center;">0.012</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CALB1</td>
<td style="text-align: center;">normal</td>
<td style="text-align: left;">glomerulus - tubule</td>
<td style="text-align: center;">-2.014</td>
<td style="text-align: left;">0.027</td>
<td style="text-align: center;">0.138</td>
</tr>
<tr class="even">
<td style="text-align: left;">CD274</td>
<td style="text-align: center;">normal</td>
<td style="text-align: left;">glomerulus - tubule</td>
<td style="text-align: center;">0.223</td>
<td style="text-align: left;">0.031</td>
<td style="text-align: center;">0.147</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NPHS2</td>
<td style="text-align: center;">normal</td>
<td style="text-align: left;">glomerulus - tubule</td>
<td style="text-align: center;">5.430</td>
<td style="text-align: left;">0.002</td>
<td style="text-align: center;">0.025</td>
</tr>
<tr class="even">
<td style="text-align: left;">CLDN8</td>
<td style="text-align: center;">normal</td>
<td style="text-align: left;">glomerulus - tubule</td>
<td style="text-align: center;">-1.961</td>
<td style="text-align: left;">0.001</td>
<td style="text-align: center;">0.011</td>
</tr>
<tr class="odd">
<td style="text-align: left;">EPCAM</td>
<td style="text-align: center;">normal</td>
<td style="text-align: left;">glomerulus - tubule</td>
<td style="text-align: center;">-2.297</td>
<td style="text-align: left;">0.000</td>
<td style="text-align: center;">0.006</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="between-slide-analysis-diabetic-kidney-disease-vs-healthy" class="level3">
<h3 class="anchored" data-anchor-id="between-slide-analysis-diabetic-kidney-disease-vs-healthy"><strong>Between Slide Analysis: Diabetic Kidney Disease vs Healthy</strong></h3>
<p>Another informative exploration is to compare tissue cohorts. In this case, we would like to compare diseased versus healthy kidneys. We will focus on glomeruli as our structure. Because we are comparing disease status, which is specific to the entire kidney, we will use the LMM model without a random slope. Disease (<code>testClass</code>) is our test variable. Like our previous LMM example, we control for tissue subsampling with <code>slide name</code> as the intercept.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert test variables to factors</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pData</span>(target_demoData)<span class="sc">$</span>testClass <span class="ot">&lt;-</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">factor</span>(<span class="fu">pData</span>(target_demoData)<span class="sc">$</span>class, <span class="fu">c</span>(<span class="st">"normal"</span>, <span class="st">"DKD"</span>))</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co"># run LMM:</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co"># formula follows conventions defined by the lme4 package</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>results2 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(region <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"glomerulus"</span>, <span class="st">"tubule"</span>)) {</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    ind <span class="ot">&lt;-</span> <span class="fu">pData</span>(target_demoData)<span class="sc">$</span>region <span class="sc">==</span> region</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    mixedOutmc <span class="ot">&lt;-</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mixedModelDE</span>(target_demoData[, ind],</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">elt =</span> <span class="st">"log_q"</span>,</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">modelFormula =</span> <span class="sc">~</span> testClass <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> slide),</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">groupVar =</span> <span class="st">"testClass"</span>,</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nCores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>(),</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">multiCore =</span> <span class="cn">FALSE</span>)</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># format results as data.frame</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>    r_test <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, mixedOutmc[<span class="st">"lsmeans"</span>, ])</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>    tests <span class="ot">&lt;-</span> <span class="fu">rownames</span>(r_test)</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>    r_test <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(r_test)</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>    r_test<span class="sc">$</span>Contrast <span class="ot">&lt;-</span> tests</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># use lapply in case you have multiple levels of your test factor to</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># correctly associate gene name with it's row in the results table</span></span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>    r_test<span class="sc">$</span>Gene <span class="ot">&lt;-</span> </span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="fu">colnames</span>(mixedOutmc),</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>                      rep, <span class="fu">nrow</span>(mixedOutmc[<span class="st">"lsmeans"</span>, ][[<span class="dv">1</span>]])))</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>    r_test<span class="sc">$</span>Subset <span class="ot">&lt;-</span> region</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>    r_test<span class="sc">$</span>FDR <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(r_test<span class="sc">$</span><span class="st">`</span><span class="at">Pr(&gt;|t|)</span><span class="st">`</span>, <span class="at">method =</span> <span class="st">"fdr"</span>)</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>    r_test <span class="ot">&lt;-</span> r_test[, <span class="fu">c</span>(<span class="st">"Gene"</span>, <span class="st">"Subset"</span>, <span class="st">"Contrast"</span>, <span class="st">"Estimate"</span>, </span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"Pr(&gt;|t|)"</span>, <span class="st">"FDR"</span>)]</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>    results2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results2, r_test)</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can review our genes of interest for this comparison as well. Let’s focus on results from analysis of tubules.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">subset</span>(results2, Gene <span class="sc">%in%</span> goi <span class="sc">&amp;</span> Subset <span class="sc">==</span> <span class="st">"tubule"</span>), <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"DE results for Genes of Interest"</span>,</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">align =</span> <span class="st">"lc"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<caption>DE results for Genes of Interest</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Gene</th>
<th style="text-align: center;">Subset</th>
<th style="text-align: left;">Contrast</th>
<th style="text-align: center;">Estimate</th>
<th style="text-align: left;">Pr(&gt;|t|)</th>
<th style="text-align: center;">FDR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">KRT18</td>
<td style="text-align: center;">tubule</td>
<td style="text-align: left;">normal - DKD</td>
<td style="text-align: center;">-0.096</td>
<td style="text-align: left;">0.748</td>
<td style="text-align: center;">0.997</td>
</tr>
<tr class="even">
<td style="text-align: left;">CD68</td>
<td style="text-align: center;">tubule</td>
<td style="text-align: left;">normal - DKD</td>
<td style="text-align: center;">-0.726</td>
<td style="text-align: left;">0.124</td>
<td style="text-align: center;">0.965</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CD8A</td>
<td style="text-align: center;">tubule</td>
<td style="text-align: left;">normal - DKD</td>
<td style="text-align: center;">-0.057</td>
<td style="text-align: left;">0.826</td>
<td style="text-align: center;">0.998</td>
</tr>
<tr class="even">
<td style="text-align: left;">NPHS1</td>
<td style="text-align: center;">tubule</td>
<td style="text-align: left;">normal - DKD</td>
<td style="text-align: center;">-0.131</td>
<td style="text-align: left;">0.624</td>
<td style="text-align: center;">0.997</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CALB1</td>
<td style="text-align: center;">tubule</td>
<td style="text-align: left;">normal - DKD</td>
<td style="text-align: center;">1.408</td>
<td style="text-align: left;">0.013</td>
<td style="text-align: center;">0.652</td>
</tr>
<tr class="even">
<td style="text-align: left;">CD274</td>
<td style="text-align: center;">tubule</td>
<td style="text-align: left;">normal - DKD</td>
<td style="text-align: center;">-0.252</td>
<td style="text-align: left;">0.522</td>
<td style="text-align: center;">0.997</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NPHS2</td>
<td style="text-align: center;">tubule</td>
<td style="text-align: left;">normal - DKD</td>
<td style="text-align: center;">-0.128</td>
<td style="text-align: left;">0.730</td>
<td style="text-align: center;">0.997</td>
</tr>
<tr class="even">
<td style="text-align: left;">CLDN8</td>
<td style="text-align: center;">tubule</td>
<td style="text-align: left;">normal - DKD</td>
<td style="text-align: center;">0.979</td>
<td style="text-align: left;">0.000</td>
<td style="text-align: center;">0.058</td>
</tr>
<tr class="odd">
<td style="text-align: left;">EPCAM</td>
<td style="text-align: center;">tubule</td>
<td style="text-align: left;">normal - DKD</td>
<td style="text-align: center;">0.339</td>
<td style="text-align: left;">0.382</td>
<td style="text-align: center;">0.997</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="visualizing-de-genes" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-de-genes"><strong>Visualizing DE Genes</strong></h2>
<section id="volcano-plots" class="level3">
<h3 class="anchored" data-anchor-id="volcano-plots"><strong>Volcano Plots</strong></h3>
<p>A canonical visualization for interpreting differential gene expression results is the volcano plot. Let’s look at the LMM results from our diseased glomeruli versus tubules comparison.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggrepel' was built under R version 4.2.2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Categorize Results based on P-value &amp; FDR for plotting</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>Color <span class="ot">&lt;-</span> <span class="st">"NS or FC &lt; 0.5"</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>Color[results<span class="sc">$</span><span class="st">`</span><span class="at">Pr(&gt;|t|)</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="fl">0.05</span>] <span class="ot">&lt;-</span> <span class="st">"P &lt; 0.05"</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>Color[results<span class="sc">$</span>FDR <span class="sc">&lt;</span> <span class="fl">0.05</span>] <span class="ot">&lt;-</span> <span class="st">"FDR &lt; 0.05"</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>Color[results<span class="sc">$</span>FDR <span class="sc">&lt;</span> <span class="fl">0.001</span>] <span class="ot">&lt;-</span> <span class="st">"FDR &lt; 0.001"</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>Color[<span class="fu">abs</span>(results<span class="sc">$</span>Estimate) <span class="sc">&lt;</span> <span class="fl">0.5</span>] <span class="ot">&lt;-</span> <span class="st">"NS or FC &lt; 0.5"</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>Color <span class="ot">&lt;-</span> <span class="fu">factor</span>(results<span class="sc">$</span>Color,</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"NS or FC &lt; 0.5"</span>, <span class="st">"P &lt; 0.05"</span>,</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"FDR &lt; 0.05"</span>, <span class="st">"FDR &lt; 0.001"</span>))</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="co"># pick top genes for either side of volcano to label</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="co"># order genes for convenience:</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>invert_P <span class="ot">&lt;-</span> (<span class="sc">-</span><span class="fu">log10</span>(results<span class="sc">$</span><span class="st">`</span><span class="at">Pr(&gt;|t|)</span><span class="st">`</span>)) <span class="sc">*</span> <span class="fu">sign</span>(results<span class="sc">$</span>Estimate)</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>top_g <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(cond <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"DKD"</span>, <span class="st">"normal"</span>)) {</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>    ind <span class="ot">&lt;-</span> results<span class="sc">$</span>Subset <span class="sc">==</span> cond</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>    top_g <span class="ot">&lt;-</span> <span class="fu">c</span>(top_g,</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>               results[ind, <span class="st">'Gene'</span>][</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">order</span>(results[ind, <span class="st">'invert_P'</span>], <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>]],</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>               results[ind, <span class="st">'Gene'</span>][</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">order</span>(results[ind, <span class="st">'invert_P'</span>], <span class="at">decreasing =</span> <span class="cn">FALSE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>]])</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>top_g <span class="ot">&lt;-</span> <span class="fu">unique</span>(top_g)</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> results[, <span class="sc">-</span><span class="dv">1</span><span class="sc">*</span><span class="fu">ncol</span>(results)] <span class="co"># remove invert_P from matrix</span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Graph results</span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results,</span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> Estimate, <span class="at">y =</span> <span class="sc">-</span><span class="fu">log10</span>(<span class="st">`</span><span class="at">Pr(&gt;|t|)</span><span class="st">`</span>),</span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> Color, <span class="at">label =</span> Gene)) <span class="sc">+</span></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.5</span>), <span class="at">lty =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="sc">-</span><span class="fu">log10</span>(<span class="fl">0.05</span>), <span class="at">lty =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Enriched in Tubules &lt;- log2(FC) -&gt; Enriched in Glomeruli"</span>,</span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Significance, -log10(P)"</span>,</span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">"Significance"</span>) <span class="sc">+</span></span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">FDR &lt; 0.001</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"dodgerblue"</span>,</span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">`</span><span class="at">FDR &lt; 0.05</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"lightblue"</span>,</span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">`</span><span class="at">P &lt; 0.05</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"orange2"</span>,</span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">`</span><span class="at">NS or FC &lt; 0.5</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"gray"</span>),</span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a>                       <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">4</span>))) <span class="sc">+</span></span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.05</span>))) <span class="sc">+</span></span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text_repel</span>(<span class="at">data =</span> <span class="fu">subset</span>(results, Gene <span class="sc">%in%</span> top_g <span class="sc">&amp;</span> FDR <span class="sc">&lt;</span> <span class="fl">0.001</span>),</span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size =</span> <span class="dv">2</span>, <span class="at">point.padding =</span> <span class="fl">0.15</span>, <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a>                    <span class="at">min.segment.length =</span> .<span class="dv">1</span>, <span class="at">box.padding =</span> .<span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a>                    <span class="at">max.overlaps =</span> <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>Subset, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Duplicated aesthetics after name standardisation: size</code></pre>
</div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The volcano plot shows several genes that are significantly differentially expressed between glomeruli and tubules, though some are specific to the disease status of the sample. Note that because we use the linear mixed effect model to account for tissue specific variation, the volcano plot shape may look less typical than one generated with a linear regression model. There are some genes for which we see high fold change, but lower significance, because these genes appear to be behaving in a sample-specific manner rather than consistently across all kidney samples.</p>
</section>
<section id="section-1" class="level3">
<h3 class="anchored" data-anchor-id="section-1"></h3>
</section>
<section id="ma-plot" class="level3">
<h3 class="anchored" data-anchor-id="ma-plot"><strong>MA Plot</strong></h3>
<p>Another visualization for differential expression is an MA plot. With this plot, we look for differences relative to expression within the baseline feature. As we have filtered out genes with low expression, the MA plot will not exhibit a traditional shape, but it can be useful in identifying targets with relatively high fold change and baseline expression. In the plot below we keep the labeled genes within the top 90th percentile of expression on average with an FDR of &lt; 0.001 and a log<sub>2</sub> FC &gt; 0.5.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>results<span class="sc">$</span>MeanExp <span class="ot">&lt;-</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rowMeans</span>(<span class="fu">assayDataElement</span>(target_demoData,</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">elt =</span> <span class="st">"q_norm"</span>))</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>top_g2 <span class="ot">&lt;-</span> results<span class="sc">$</span>Gene[results<span class="sc">$</span>Gene <span class="sc">%in%</span> top_g <span class="sc">&amp;</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>                           results<span class="sc">$</span>FDR <span class="sc">&lt;</span> <span class="fl">0.001</span> <span class="sc">&amp;</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">abs</span>(results<span class="sc">$</span>Estimate) <span class="sc">&gt;</span> .<span class="dv">5</span> <span class="sc">&amp;</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>                           results<span class="sc">$</span>MeanExp <span class="sc">&gt;</span> <span class="fu">quantile</span>(results<span class="sc">$</span>MeanExp, <span class="fl">0.9</span>)]</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">subset</span>(results, <span class="sc">!</span>Gene <span class="sc">%in%</span> neg_probes),</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> MeanExp, <span class="at">y =</span> Estimate,</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">size =</span> <span class="sc">-</span><span class="fu">log10</span>(<span class="st">`</span><span class="at">Pr(&gt;|t|)</span><span class="st">`</span>),</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> Color, <span class="at">label =</span> Gene)) <span class="sc">+</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.5</span>), <span class="at">lty =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">trans =</span> <span class="st">"log2"</span>) <span class="sc">+</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Enriched in Glomeruli &lt;- log2(FC) -&gt; Enriched in Tubules"</span>,</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Mean Expression"</span>,</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">"Significance"</span>) <span class="sc">+</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">FDR &lt; 0.001</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"dodgerblue"</span>,</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">`</span><span class="at">FDR &lt; 0.05</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"lightblue"</span>,</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">`</span><span class="at">P &lt; 0.05</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"orange2"</span>,</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">`</span><span class="at">NS or FC &lt; 0.5</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"gray"</span>)) <span class="sc">+</span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_text_repel</span>(<span class="at">data =</span> <span class="fu">subset</span>(results, Gene <span class="sc">%in%</span> top_g2),</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>                    <span class="at">size =</span> <span class="dv">4</span>, <span class="at">point.padding =</span> <span class="fl">0.15</span>, <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>                    <span class="at">min.segment.length =</span> .<span class="dv">1</span>, <span class="at">box.padding =</span> .<span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>Subset, <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Duplicated aesthetics after name standardisation: size</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: ggrepel: 5 unlabeled data points (too many overlaps). Consider
increasing max.overlaps</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: ggrepel: 2 unlabeled data points (too many overlaps). Consider
increasing max.overlaps</code></pre>
</div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="plotting-genes-of-interest" class="level3">
<h3 class="anchored" data-anchor-id="plotting-genes-of-interest"><strong>Plotting Genes of Interest</strong></h3>
<p>A simple and effective plot to view individual genes is the violin plot. This visualization reveals both the dynamic range and shape of the distribution for a gene target. We selected a few genes for which we validated structure-specific expression from the <a href="https://www.proteinatlas.org/">Human Protein Atlas</a>. We will plot a gene enriched within the glomeruli, <a href="https://www.proteinatlas.org/ENSG00000150093-ITGB1/tissue/kidney">ITGB1</a> and a gene enriched within tubules, <a href="https://www.proteinatlas.org/ENSG00000131828-PDHA1/tissue/kidney">PDHA1</a>.</p>
<p>First let’s review the model results for these targets:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">subset</span>(results, Gene <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'PDHA1'</span>,<span class="st">'ITGB1'</span>)), <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 21%">
<col style="width: 11%">
<col style="width: 20%">
<col style="width: 10%">
<col style="width: 12%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Gene</th>
<th style="text-align: left;">Subset</th>
<th style="text-align: left;">Contrast</th>
<th style="text-align: right;">Estimate</th>
<th style="text-align: right;">Pr(&gt;|t|)</th>
<th style="text-align: right;">FDR</th>
<th style="text-align: left;">Color</th>
<th style="text-align: right;">MeanExp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">PDHA1</td>
<td style="text-align: left;">DKD</td>
<td style="text-align: left;">glomerulus - tubule</td>
<td style="text-align: right;">-1.0657650</td>
<td style="text-align: right;">0.0065159</td>
<td style="text-align: right;">0.1122655</td>
<td style="text-align: left;">P &lt; 0.05</td>
<td style="text-align: right;">24.82625</td>
</tr>
<tr class="even">
<td style="text-align: left;">ITGB1</td>
<td style="text-align: left;">DKD</td>
<td style="text-align: left;">glomerulus - tubule</td>
<td style="text-align: right;">0.6769474</td>
<td style="text-align: right;">0.0307688</td>
<td style="text-align: right;">0.2192658</td>
<td style="text-align: left;">P &lt; 0.05</td>
<td style="text-align: right;">104.30101</td>
</tr>
<tr class="odd">
<td style="text-align: left;">PDHA1</td>
<td style="text-align: left;">normal</td>
<td style="text-align: left;">glomerulus - tubule</td>
<td style="text-align: right;">-1.5416314</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: left;">FDR &lt; 0.001</td>
<td style="text-align: right;">24.82625</td>
</tr>
<tr class="even">
<td style="text-align: left;">ITGB1</td>
<td style="text-align: left;">normal</td>
<td style="text-align: left;">glomerulus - tubule</td>
<td style="text-align: right;">1.5042831</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: right;">0.0000000</td>
<td style="text-align: left;">FDR &lt; 0.001</td>
<td style="text-align: right;">104.30101</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Here we see that while these genes are significantly enriched in a structure, the structure-specific expression is also specific to the healthy tissue.</p>
</section>
<section id="heatmap-of-significant-genes" class="level3">
<h3 class="anchored" data-anchor-id="heatmap-of-significant-genes"><strong>Heatmap of Significant Genes</strong></h3>
<p>In addition to generating individual gene box plots or volcano plots, we can again create a heatmap from our data. This time rather than utilizing CV to select genes, we can use the P-value or FDR values to select genes. Here, we plot all genes with an FDR &lt; 0.001.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select top significant genes based on significance, plot with pheatmap</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>GOI <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">subset</span>(results, <span class="st">`</span><span class="at">FDR</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="fl">0.001</span>)<span class="sc">$</span>Gene)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(<span class="fu">log2</span>(<span class="fu">assayDataElement</span>(target_demoData[GOI, ], <span class="at">elt =</span> <span class="st">"q_norm"</span>)),</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">scale =</span> <span class="st">"row"</span>, </span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">show_rownames =</span> <span class="cn">FALSE</span>, <span class="at">show_colnames =</span> <span class="cn">FALSE</span>,</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">border_color =</span> <span class="cn">NA</span>,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">clustering_method =</span> <span class="st">"average"</span>,</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">clustering_distance_rows =</span> <span class="st">"correlation"</span>,</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">clustering_distance_cols =</span> <span class="st">"correlation"</span>,</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">cutree_cols =</span> <span class="dv">2</span>, <span class="at">cutree_rows =</span> <span class="dv">2</span>,</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="fl">0.05</span>),</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"purple3"</span>, <span class="st">"black"</span>, <span class="st">"yellow2"</span>))(<span class="dv">120</span>),</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">annotation_col =</span> <span class="fu">pData</span>(target_demoData)[, <span class="fu">c</span>(<span class="st">"region"</span>, <span class="st">"class"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="geomx_project_detail_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="section-2" class="level2">
<h2 class="anchored" data-anchor-id="section-2"></h2>
</section>
<section id="section-3" class="level2">
<h2 class="anchored" data-anchor-id="section-3"></h2>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>